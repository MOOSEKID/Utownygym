import{T as H,U as O,m as w,_ as Q,d as v,o as d,e as h,w as l,h as n,al as I,g as f,ah as B,X as U,f as m,F as g,p as V,j as k,t as p,O as T,ad as D,ag as N,ck as M,cl as R,s as S,i as _,aq as F,af as E,Q as j,S as X,q as x,n as Y,R as Z,N as L,aY as G,aZ as J}from"./index.ec7eb99e.js";import{Q as K}from"./QBadge.f11b4156.js";import{Q as y}from"./QTd.ce5eb0a5.js";import{c as A,Q as W}from"./QTable.e99aec6c.js";import{Q as $}from"./QSelect.ad394656.js";import{Q as q}from"./QTr.4bf4ade2.js";import{u as z}from"./index.22ce7155.js";import{C as ee,A as te}from"./AddDiscount.6731a85e.js";const oe={data(){return{selected:this.modelValue,products:[],current_page:1,last_page:1,loading:!1,filter:this.query,sortBy:"TITLE_ASC",product_columns:[{name:"thumbnail",label:"Product",field:"thumbnail",align:"left",sortable:!1},{name:"source_stock",label:"Total Available",field:e=>e.has_variant?"":this.getStocks(e,this.source),align:"right",sortable:!1,style:"width: 150px; white-space: normal"}]}},props:{modelValue:{required:!1,type:[Array],default:()=>[]},source:{required:!1,type:[Object,Boolean],default:!1},columns:{required:!1,type:[Array],default:()=>[]},hint:[String],query:[String],title:{type:[String],default:"Select products"},loadFromServer:{type:[Boolean],required:!1,default:!0}},emits:["ok","hide"],methods:{...H(z,["get"]),onLoadProduct(e){var t;console.func("components/product/InventorySelector:methods.onLoadProduct()",arguments),this.loading=!0,this.current_page=e.page,this.get({...e,filter:this.filter,sortBy:this.sortBy,rowsPerPage:10,location:(t=this.source)==null?void 0:t.id,includes:["variants","default_variant"]}).then(({data:s,meta:c})=>{this.products=s,this.current_page=c.current_page,this.last_page=c.last_page,this.loading=!1}).catch(()=>{this.loading=!1})},async show(){console.func("components/product/InventorySelector:methods.show()",arguments),this.loadFromServer&&await this.onLoadProduct({page:this.current_page}),this.columns.forEach(e=>{this.product_columns.push(e)}),this.$refs.dialog.show()},hide(){console.func("components/product/InventorySelector:methods.close()",arguments),this.$refs.dialog.hide()},onDialogHide(){console.func("components/product/InventorySelector:methods.onDialogHide()",arguments),this.$emit("hide")},onDone(){console.func("components/product/InventorySelector:methods.onDone()",arguments),this.$emit("ok",this.selected),this.hide()},onSelected(e){if(console.func("components/product/InventorySelector:methods.onSelected()",arguments),e.has_variant){const t=this.selected.filter(c=>c.product_id===e.id).length,s=e.variants.length;e.variants.forEach(c=>{this.onVariantSelected(c,e,t===s)})}else this.onVariantSelected(e.default_variant,e)},onVariantSelected(e,t,s=!0){console.func("components/product/InventorySelector:methods.onVariantSelected()",arguments),this.selectedVariants.filter(o=>o===e.id).length?s&&(this.selected=this.selected.filter(o=>o.variant_id!==e.id)):this.selected.push({product_id:e.product_id,product:t,title:t.title,variant_id:e.id,taxable:e.taxable,variant:e,variant_title:e.title,price:e.price,thumbnail:e.thumbnail,sku:e.sku,quantity:1})},onBrowseProduct(e,t){console.func("components/product/InventorySelector:methods.onBrowseProduct()",arguments),this[t]=e,this.onLoadProduct({page:1})},getStocks(e,t){if(!e.default_variant.inventories.length)return"-";const s=e.default_variant.inventories.filter(o=>t&&o.location_id===t.id&&o.active||!t&&o.active).map(o=>parseInt(o.available));if(!s.length)return"-";const c=s.reduce((o,r)=>o+r);return c<=0?`<span class="no-inventory">${c}</span>`:c},getVariantStocks(e,t){if(!e.inventories.length)return"-";const s=e.inventories.filter(o=>t&&o.location_id===t.id&&o.active||!t&&o.active).map(o=>parseInt(o.available));if(!s.length)return"-";const c=s.reduce((o,r)=>o+r);return c<=0?`<span class="no-inventory">${c}</span>`:c}},computed:{...O(z,["sortOptions"]),disable(){return this.selected===this.modelValue},visibleColumns(){return this.product_columns.map(e=>e.name)},selectedVariants(){return w.exports.uniq(this.selected.filter(e=>e.variant_id).map(e=>e.variant_id))},selectedProducts(){return w.exports.uniq(this.selected.filter(e=>e.product_id).map(e=>e.product_id))}}},ne={class:"col"},le={class:"col-auto"},se={style:{width:"280px"},class:"flex items-center"},ae={style:{width:"200px","white-space":"normal"},class:"q-ml-md"},re=["innerHTML"],ie=["innerHTML"],de=["innerHTML"],ce=["innerHTML"],ue={class:"q-gutter-sm"};function me(e,t,s,c,o,r){const b=v("base-thumbnail"),P=v("base-dialog");return d(),h(P,{title:s.title,"body-class":"q-pa-none","body-style":"",ref:"dialog",persistent:"",onHide:r.onDialogHide,"use-separator":""},{body:l(()=>[n(I,{class:"q-col-gutter-md row"},{default:l(()=>[f("div",ne,[n(B,{dense:"",outlined:"",type:"text",modelValue:o.filter,"onUpdate:modelValue":[t[0]||(t[0]=i=>o.filter=i),t[1]||(t[1]=i=>r.onBrowseProduct(i,"filter"))],clearable:"",debounce:"500",placeholder:"Search products"},null,8,["modelValue"])]),f("div",le,[n($,{style:{width:"200px"},prefix:"Sort: ","map-options":"","options-dense":"","emit-value":"",modelValue:o.sortBy,"onUpdate:modelValue":[t[2]||(t[2]=i=>o.sortBy=i),t[3]||(t[3]=i=>r.onBrowseProduct(i,"sortBy"))],options:e.sortOptions,dense:"",outlined:""},null,8,["modelValue","options"])])]),_:1}),n(U),n(A,{flat:"",square:"",style:{"max-height":"50vh","min-height":"50vh"},rows:o.products,columns:o.product_columns,"row-key":"id","hide-bottom":"",class:"sticky-header","visible-columns":r.visibleColumns},{header:l(i=>[n(q,{props:i},{default:l(()=>[(d(!0),m(g,null,V(i.cols,u=>(d(),h(W,{key:u.name,props:i},{default:l(()=>[k(p(u.label),1)]),_:2},1032,["props"]))),128))]),_:2},1032,["props"])]),body:l(i=>[n(q,{onClick:u=>r.onSelected(i.row),class:"cursor-pointer",props:i},{default:l(()=>[(d(!0),m(g,null,V(i.cols,u=>(d(),h(y,{key:u.name,props:i},{default:l(()=>[u.name==="thumbnail"?(d(),h(T,{key:0,size:"sm",dense:"","model-value":r.selectedProducts,"onUpdate:modelValue":a=>r.onSelected(i.row),val:i.row.id},{default:l(()=>[f("div",se,[f("div",null,[n(b,{size:40,media:i.row.thumbnail},null,8,["media"])]),f("div",ae,p(i.row.title),1)])]),_:2},1032,["model-value","onUpdate:modelValue","val"])):u.name==="source_stock"?(d(),m("span",{key:1,innerHTML:u.value},null,8,re)):(d(),m("span",{key:2,innerHTML:u.value},null,8,ie))]),_:2},1032,["props"]))),128))]),_:2},1032,["onClick","props"]),(d(!0),m(g,null,V(i.row.variants,(u,a)=>D((d(),h(q,{key:a,props:i,class:"cursor-pointer",onClick:C=>r.onVariantSelected(u,i.row)},{default:l(()=>[n(y,{colspan:"1",style:{width:"50px"}},{default:l(()=>[n(T,{class:"q-ml-xl",size:"sm",dense:"","model-value":r.selectedVariants,"onUpdate:modelValue":C=>r.onVariantSelected(u,i.row),val:u.id},{default:l(()=>[f("div",null,p(u.title),1)]),_:2},1032,["model-value","onUpdate:modelValue","val"])]),_:2},1024),n(y,{colspan:"1",class:"text-right"},{default:l(()=>[f("span",{innerHTML:r.getVariantStocks(u,s.source)},null,8,de)]),_:2},1024),n(y,{colspan:"1",class:"text-right"},{default:l(()=>[f("span",{innerHTML:u.price_formated},null,8,ce)]),_:2},1024)]),_:2},1032,["props","onClick"])),[[N,i.row.has_variant]])),128))]),_:1},8,["rows","columns","visible-columns"]),n(M,{showing:o.loading},{default:l(()=>[n(R,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),footer:l(()=>[n(I,{class:"flex"},{default:l(()=>[s.loadFromServer?(d(),m(g,{key:0},[n(S,{disable:o.current_page<=1||o.loading,onClick:t[4]||(t[4]=i=>r.onLoadProduct({page:o.current_page-1>=1?o.current_page-1:1})),dense:"",round:"",flat:"",color:"primary",icon:"fal fa-angle-left"},null,8,["disable"]),n(S,{disable:o.current_page==o.last_page||o.loading,onClick:t[5]||(t[5]=i=>r.onLoadProduct({page:o.current_page+1<=o.last_page?o.current_page+1:1})),dense:"",round:"",flat:"",color:"primary",icon:"fal fa-angle-right"},null,8,["disable"])],64)):_("",!0),n(F),f("div",ue,[D(n(S,{"no-caps":"",outline:"",label:e.$t("label.cancel"),color:"grey"},null,8,["label"]),[[E]]),n(S,{disable:r.disable,"no-caps":"",label:e.$t("label.done"),color:"primary",onClick:r.onDone},null,8,["disable","label","onClick"])])]),_:1})]),_:1},8,["title","onHide"])}var he=Q(oe,[["render",me]]);const pe={props:{title:String,product_id:[String,Number],variant_id:[String,Number],is_product_deleted:{type:Boolean,default:!1},is_variant_deleted:{type:Boolean,default:!1},is_custom:{type:Boolean,default:!1},attributes:Object},computed:{link(){const e={action:"edit"};return this.is_variant_deleted?{name:"Product",params:{id:this.product_id},query:e}:{name:"Products Variant",params:{product_id:this.product_id,variant_id:this.variant_id},query:e}}}},fe={key:1};function _e(e,t,s,c,o,r){const b=v("base-btn"),P=v("base-tooltip");return d(),m("div",null,[s.is_custom?(d(),m(g,{key:0},[k(p(s.title),1)],64)):(d(),m(g,{key:1},[s.is_product_deleted?(d(),m("span",fe,[k(p(s.title)+" ",1),s.is_product_deleted?(d(),h(j,{key:0,class:"q-ml-xs",name:"fad fa-info-circle",size:"13px",color:"negative"},{default:l(()=>[n(P,null,{default:l(()=>t[0]||(t[0]=[k("This product has been deleted.")])),_:1})]),_:1})):_("",!0)])):(d(),h(b,{key:0,link:"",size:"12px",tag:"a",to:r.link},{default:l(()=>[k(p(s.title),1)]),_:1},8,["to"]))],64))])}var ve=Q(pe,[["render",_e]]);const ge={components:{ProductTitle:ve},props:{modelValue:{type:[Array],required:!0},currency:String,view:Boolean,canNotRemove:Boolean},emits:["update:model-value"],data(){return{products:w.exports.cloneDeep(this.modelValue),columns:[{name:"product",align:"left",label:"Product",field:"title",sortable:!1,view:!0},{name:"price",align:"right",label:"Price",style:"width: 150px;",field:"discounted_price",format:e=>this.$core.money(e),sortable:!1,view:!0},{name:"quantity",align:"left",label:"Quantity",style:"width: 150px;",field:"quantity",sortable:!1,view:!1},{name:"total",align:this.view?"right":"left",label:"Total",style:"width: 90px;",field:"total",format:e=>this.$core.money(e),sortable:!1,view:!0},{name:"action",align:"right",style:"width: 10px; padding-left: 0",field:"action",sortable:!1,view:!1}]}},methods:{onBrowseProduct(e){console.func("components/order/ProductsCard:methods.onBrowseProduct()",arguments),this.$q.dialog({component:he,componentProps:{query:e,columns:[{name:"price",label:"Price",field:t=>t.has_variant?"":t.price,align:"right",sortable:!1,style:"width: 150px; white-space: normal"}],modelValue:w.exports.cloneDeep(this.products)}}).onOk(t=>{console.func("components/order/ProductsCard:methods.onBrowseProduct.onOk()",t),this.products=w.exports.cloneDeep(t),this.$emit("update:model-value",this.products)})},onRemoveItem({rowIndex:e}){console.func("components/order/ProductsCard:methods.onRemoveItem()",arguments),this.products.splice(e,1),this.$emit("update:model-value",this.products)},onAddCustomProduct(){console.func("components/order/ProductsCard:methods.onAddCustomProduct()",arguments),this.$q.dialog({component:ee}).onOk(e=>{console.func("components/order/ProductsCard:methods.onAddCustomProduct.onOk()",e),this.products.push(e),this.$emit("update:model-value",this.products)})},onChangeQuantity(){console.func("components/order/ProductsCard:methods.onChangeQuantity()",arguments),this.$core.debounce(()=>{this.$emit("update:model-value",this.products)},500)},addDiscount(e){console.func("components/order/ProductsCard:methods.addDiscount()",arguments),this.$q.dialog({component:te,componentProps:{modelValue:w.exports.cloneDeep(e.discount),update:Boolean(e.discount)}}).onOk(t=>{console.func("components/order/ProductsCard:methods.addDiscount.onOk()",t),t||(e.discount_removed=!0),e.discount=t,this.$emit("update:model-value",this.products)})}},watch:{modelValue:{deep:!0,handler(e){this.products=w.exports.cloneDeep(e)}}},computed:{visibleColumns(){return this.columns.filter(e=>this.view&&e.view||!this.view).filter(e=>this.canNotRemove&&e.name!=="action"||!this.canNotRemove).map(e=>e.name)}}},ye={key:0,class:"q-mb-md row"},be={class:"col"},we={key:1},ke={key:0},Se={key:1},Pe={key:0,class:"q-ml-sm text-strike text-grey"},Ce={key:2};function Ve(e,t,s,c,o,r){const b=v("base-btn"),P=v("base-thumbnail"),i=v("product-title"),u=v("base-section");return d(),h(u,{title:"Products","no-row":""},X({action:l(()=>[s.view?_("",!0):(d(),h(b,{key:0,link:"",size:"14px",padding:"0",label:"Add custom product",onClick:r.onAddCustomProduct},null,8,["onClick"])),x(e.$slots,"action")]),default:l(()=>[s.view?_("",!0):(d(),m("div",ye,[f("div",be,[n(B,{dense:"",outlined:"",type:"text",placeholder:"Search products",debounce:"500","onUpdate:modelValue":r.onBrowseProduct},{after:l(()=>[n(S,{onClick:t[0]||(t[0]=a=>r.onBrowseProduct("")),"no-caps":"",outline:"",padding:"8px",style:{width:"100px"},color:"primary",label:"Browse"})]),_:1},8,["onUpdate:modelValue"])])])),x(e.$slots,"top"),o.products.length?(d(),m("div",we,[n(A,{ref:"product",class:Y({"main-table":!s.view,"no-hover":s.view}),square:"",flat:"",dense:s.view,"hide-header":s.view,rows:o.products,columns:o.columns,"hide-pagination":"","rows-per-page-options":[0],"visible-columns":r.visibleColumns,separator:s.view?"none":"horizontal"},{"body-cell-product":l(a=>[n(y,{props:a},{default:l(()=>[n(Z,{class:"q-pa-none",dense:""},{default:l(()=>[n(L,{avatar:""},{default:l(()=>[n(P,{size:40,media:a.row.thumbnail},{default:l(()=>[s.view?(d(),h(K,{key:0,rounded:"",floating:"",color:"orange-3","text-color":"black",label:a.row.remaining_quantity||a.row.quantity},null,8,["label"])):_("",!0)]),_:2},1032,["media"])]),_:2},1024),n(L,{avatar:""},{default:l(()=>[n(i,G(J(a.row)),null,16),a.row.variant_title?(d(),m("div",ke,p(a.row.variant_title),1)):_("",!0),a.row.reason?(d(),m("div",Se," Reason: "+p(a.row.reason),1)):_("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-quantity":l(a=>[n(y,{props:a},{default:l(()=>[n(B,{dense:"",outlined:"",modelValue:a.row.quantity,"onUpdate:modelValue":[C=>a.row.quantity=C,r.onChangeQuantity],modelModifiers:{number:!0},"input-style":"text-align: center",type:"number",min:"1"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-price":l(a=>[n(y,{props:a},{default:l(()=>[s.view?(d(),m(g,{key:0},[a.row.has_discount?(d(),h(b,{key:0,link:"",class:"text-strike",label:a.row.price},null,8,["label"])):_("",!0),k(" "+p(a.value)+" x "+p(a.row.remaining_quantity||a.row.quantity),1)],64)):(d(),m(g,{key:1},[n(b,{link:"",color:"primary",size:"0.72rem",onClick:C=>r.addDiscount(a.row),label:a.value},null,8,["onClick","label"]),a.row.has_discount?(d(),m("span",Pe,p(e.$core.money(a.row.price,{currency:s.currency})),1)):_("",!0)],64))]),_:2},1032,["props"])]),"body-cell-action":l(a=>[n(y,{props:a},{default:l(()=>[n(S,{round:"",dense:"",flat:"",size:"sm",color:"primary",icon:"fal fa-times",onClick:C=>r.onRemoveItem(a)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["class","dense","hide-header","rows","columns","visible-columns","separator"])])):(d(),m("div",Ce))]),_:2},[e.$slots.bottom?{name:"bottom",fn:l(()=>[x(e.$slots,"bottom")]),key:"0"}:void 0]),1024)}var ze=Q(ge,[["render",Ve]]);export{ze as P};
